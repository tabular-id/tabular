# Flathub-style manifest template for Tabular.
# Saat submit ke Flathub, file ini biasanya berada
# di repo khusus flathub (bukan di repo app langsung).

app-id: id.tabular.database
branch: stable
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.llvm18
command: tabular

finish-args:
  # GUI & graphics
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri

  # Network access to databases
  - --share=network

  # Allow access to user files (bisa dipersempit nanti)
  - --filesystem=home

  # Optional: access to SSH agent (for tunnels)
  - --socket=ssh-auth

modules:
  - name: tabular
    buildsystem: simple
    build-options:
      env:
        RUSTFLAGS: "-C debuginfo=0 -C opt-level=3"
    build-commands:
      # Enable Rust and LLVM, then build
      - . /usr/lib/sdk/rust-stable/enable.sh && . /usr/lib/sdk/llvm18/enable.sh && cargo --offline fetch --manifest-path Cargo.toml --verbose
      - . /usr/lib/sdk/rust-stable/enable.sh && . /usr/lib/sdk/llvm18/enable.sh && cargo build --release --offline
      # Install binary into /app
      - install -Dm755 target/release/tabular /app/bin/tabular
      # Install desktop file; adapt for Flatpak
      - install -Dm644 tabular.desktop /app/share/applications/id.tabular.database.desktop
      - sed -i 's|^Exec=.*$|Exec=tabular|' /app/share/applications/id.tabular.database.desktop
      - sed -i 's|^TryExec=.*$|TryExec=tabular|' /app/share/applications/id.tabular.database.desktop || true
      - sed -i 's|^Icon=.*$|Icon=id.tabular.database|' /app/share/applications/id.tabular.database.desktop
      # Install icon
      - install -Dm644 assets/logo-512.png /app/share/icons/hicolor/512x512/apps/id.tabular.database.png
      # Install appstream metadata
      - install -Dm644 id.tabular.database.metainfo.xml /app/share/metainfo/id.tabular.database.metainfo.xml
    sources:
      - type: git
        url: https://github.com/tabular-id/tabular.git
        tag: v0.5.27
        commit: COMMIT_HASH_HERE
      # Generated cargo sources - run: python3 flatpak-cargo-generator.py Cargo.lock -o generated-sources.json
      - generated-sources.json

